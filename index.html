<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEV üè† Mortgage Industry News</title>
   
    <style>
        /* --- CSS Styling and Variables --- */
        :root {
            /* Light Theme Defaults */
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --secondary-accent-1: #2ecc71; /* Community Pulse */ 
            --secondary-accent-2: #e67e22; /* Lender & Mkt Data */ 
            --secondary-accent-3: #16a085; /* Regulation & Tech */ 
            --secondary-accent-4: #f39c12; /* Real Estate & Economy */ 
            --background-color: #ecf0f1;
            --card-background: #ffffff;
            --text-color: #34495e;
            --secondary-text-color: #7f8c8d;
            --border-color: #bdc3c7;
            --hide-color: #e74c3c;
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --primary-color: #9b59b6;
            --accent-color: #3498db;
            --secondary-accent-1: #1abc9c;
            --secondary-accent-2: #d35400;
            --secondary-accent-3: #1abc9c;
            --secondary-accent-4: #e67e22;
            --background-color: #2c3e50;
            --card-background: #34495e;
            --text-color: #ecf0f1;
            --secondary-text-color: #bdc3c7;
            --border-color: #49627a;
            --hide-color: #c0392b;
        }

        /* Midnight Mode Variables */
        body.midnight-mode {
            --primary-color: #0d1a26;
            --accent-color: #5d9cec;
            --secondary-accent-1: #48c9b0;
            --secondary-accent-2: #f5b041;
            --secondary-accent-3: #45b39d;
            --secondary-accent-4: #f7dc6f;
            --background-color: #010409;
            --card-background: #0d1117;
            --text-color: #c9d1d9;
            --secondary-text-color: #8b949e;
            --border-color: #30363d;
            --hide-color: #ff7b72;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Header Styling */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
       
        /* Header Max-Width Container */
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 { margin: 0; font-size: 1.8em; }

        /* Search Input */
        #search-input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-size: 1em;
            background-color: rgba(255, 255, 255, 0.9);
            color: var(--primary-color);
        }

        /* Control Buttons Container */
        .controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
       
        /* Filter Bar Container */
        #filter-bar-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            overflow: hidden;
            max-height: 200px; /* Max height when visible */
            padding-top: 10px;
        }
       
        #filter-bar-container.hidden {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
        }
       
        /* Theme, View, and Filter Buttons */
        .control-button {
            padding: 8px 15px;
            border: 1px solid white;
            background-color: transparent;
            color: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em;
            transition: background-color 0.2s, opacity 0.2s, border-color 0.2s;
        }

        .control-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
       
        /* Highlight active filter button */
        .control-button.active {
            background-color: white;
            color: var(--primary-color);
            border-color: white;
        }
       
        body.dark-mode .control-button.active, body.midnight-mode .control-button.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

       
        /* View Toggle Specific Styling */
        #view-toggle-row {
            display: flex;
            gap: 5px;
            border-right: 1px solid rgba(255, 255, 255, 0.5);
            padding-right: 15px;
            margin-right: 5px;
        }
        .view-button.active {
            background-color: white;
            color: var(--primary-color);
        }
        body.dark-mode .view-button.active, body.midnight-mode .view-button.active {
            background-color: var(--text-color);
            color: var(--primary-color);
        }

       
        #reset-hidden-button {
            background-color: var(--hide-color);
            border-color: var(--hide-color);
        }
        #reset-hidden-button:hover {
            opacity: 0.8;
        }

        /* Feed Sections */
        .feed-section {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            transition: max-height 0.5s ease-out, opacity 0.5s ease-out;
            overflow: hidden;
        }
       
        .feed-section.hidden {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
            margin-bottom: 0;
        }

        .feed-section h2 {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
            margin-top: 30px;
            margin-bottom: 20px;
            color: var(--primary-color);
            font-size: 1.5em;
        }

        body.dark-mode .feed-section h2, body.midnight-mode .feed-section h2 {
            border-bottom-color: var(--accent-color);
            color: var(--text-color);
        }
       
        /* Specific header colors for flair (UPDATED NAMES) */
        /* Mortgage News & Author Coverage */
        #core-mortgage-news h2 { color: var(--primary-color); } 
        #housingwire-authors h2 { color: var(--primary-color); } 
        #company-news-tags h2 { color: var(--primary-color); }
        
        /* Community Pulse/Reddit */
        #community-pulse-feed h2 { color: var(--secondary-accent-1); } 

        /* Lender Data (Branding/Campaigns replacement) */
        #lender-market-data-feed h2 { color: var(--secondary-accent-2); } 
        
        /* Regulation, Compliance, & Fintech */
        #regulation-compliance h2 { color: var(--secondary-accent-3); }
        #finance-fintech h2 { color: var(--secondary-accent-3); }

        /* Real Estate & Economy (Ad-Tech replacement) */
        #real-estate-economy-feed h2 { color: var(--secondary-accent-4); }


        /* --- VIEW CONTROLS CSS (Grid and List) --- */
       
        /* Default: GRID VIEW (Multi-Column) */
        .news-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
       
        .news-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* LIST VIEW: Overrides Grid */
        body.list-view .feed-section:not(#community-pulse-feed) .news-grid {
            display: flex; 
            flex-direction: column;
            gap: 10px; 
        }
       
        body.list-view .feed-section:not(#community-pulse-feed) .news-card {
            flex-direction: row;
            align-items: center;
            padding: 15px 20px;
            width: auto; 
        }
       
        body.list-view .feed-section:not(#community-pulse-feed) .news-card h4 {
            flex-basis: 50%;
            margin: 0;
            font-size: 1.1em;
            order: 1;
        }
       
        body.list-view .feed-section:not(#community-pulse-feed) .news-card .description,
        /* Hide the default card controls in List View */
        body.list-view .feed-section:not(#community-pulse-feed) .news-card > .card-controls.grid-controls {
            display: none; 
        }
       
        /* Target the combined date and control container in List View */
        body.list-view .feed-section:not(#community-pulse-feed) .news-card .date-and-controls {
            display: flex;
            align-items: center;
            justify-content: flex-end; 
            gap: 20px;
            flex-grow: 1; 
            order: 2;
        }

        /* Adjustments for elements inside the new container */
        body.list-view .feed-section:not(#community-pulse-feed) .news-card .date {
            border-top: none;
            padding-top: 0;
            margin: 0;
            font-size: 0.9em;
            flex-shrink: 0; 
        }
       
        body.list-view .feed-section:not(#community-pulse-feed) .news-card .card-controls.list-controls {
            /* This is the inner .card-controls inside .date-and-controls */
            display: flex !important; /* Override display:none from above */
            flex-basis: auto;
            justify-content: flex-end;
            margin: 0;
            flex-shrink: 0; 
        }
       
        body.list-view .feed-section:not(#community-pulse-feed) .news-card .card-controls.list-controls span {
            display: none; 
        }
        /* --- END VIEW CONTROLS CSS --- */


        .reddit-subsection {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px dashed var(--border-color);
            border-radius: 4px;
        }
        .reddit-subsection h3 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
            color: var(--accent-color);
        }


        .news-card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }
       
        .news-card.hidden-tile, .news-card.auto-filtered {
            display: none !important;
        }

        .news-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
       
        /* Grid View Controls (Default for .card-controls) */
        .card-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;  
        }
       
        .card-controls span {
            font-size: 0.7em;
            color: var(--secondary-text-color);
            opacity: 0.8;
        }
       
        .card-controls button {
            background: none;
            border: none;
            color: var(--hide-color);
            font-size: 0.8em;
            cursor: pointer;
            padding: 0;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
       
        .card-controls button:hover {
            opacity: 1;
        }
       
        /* List View control needs to be explicitly shown/hidden */
        .card-controls.list-controls {
            display: none; /* Hidden by default, shown in list-view mode */
        }


        .news-card h4 { margin: 0 0 10px 0; font-size: 1.15em; line-height: 1.4; }
        .news-card h4 a { color: var(--accent-color); text-decoration: none; transition: color 0.2s; }
        body.dark-mode .news-card h4 a:hover, body.midnight-mode .news-card h4 a:hover { color: var(--text-color); }

        .news-card .description {
            font-size: 0.9em;
            color: var(--secondary-text-color);
            line-height: 1.5;
            margin-top: 0;
            flex-grow: 1;  
        }
       
        /* AI Summary Panel Specific Styling */
        #ai-insight-panel {
            background-color: var(--card-background);
            border: 1px solid var(--accent-color);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            padding: 20px; /* Add padding for a better look */
        }
        
        #ai-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        #ai-summary-header h2 {
            margin: 0;
            font-size: 1.5em;
            border-bottom: none;
            padding-bottom: 0;
        }
        
        /* New styling for the status/throttle message container */
        #ai-summary-status {
            padding: 10px 0 0 0;
            margin-bottom: 10px;
            line-height: 1.5;
            white-space: pre-wrap;
            border-bottom: 1px dashed var(--border-color);
        }

        #ai-summary-content {
            padding: 10px 0 0 0; /* Adjusted padding */
            line-height: 1.6;
            white-space: pre-wrap; /* Ensures the AI's formatting (like newlines) is respected */
            margin-top: 10px;
        }
        
        #copy-summary-button {
            padding: 5px 10px;
            border: 1px solid var(--accent-color);
            background-color: var(--accent-color);
            color: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em;
            transition: background-color 0.2s, opacity 0.2s;
        }

        #copy-summary-button:hover {
            opacity: 0.9;
            background-color: var(--primary-color);
        }
    </style>
</head>
<body class="light-mode">
    <header>
    <div class="header-content">
        <div class="header-top">
            <h1>üè° DEV üíµ Residential Mortgage Feed</h1>
            <button id="theme-toggle" class="control-button" onclick="toggleTheme()">‚òÄÔ∏è Switch to Dark Mode</button>
        </div>
       
        <div id="search-container">
            <input type="text" id="search-input" placeholder="Search for rates, regulation, companies (Rocket, UWM...)..." onkeyup="filterCards()">
        </div>
       
        <div class="controls-row">
            <button id="toggle-filter-bar-btn" class="control-button" onclick="toggleFilterBar()">Hide Filter Bar</button>

            <div id="view-toggle-row">
                <button id="grid-view-button" class="view-button control-button" onclick="setListView('grid')">Grid View</button>
                <button id="list-view-button" class="view-button control-button" onclick="setListView('list')">List View</button>
            </div>
           
            <button id="reset-hidden-button" class="control-button" onclick="resetHiddenTiles()">Reset Hidden Tiles</button>
        </div>
       
        <div id="filter-bar-container">
            <button id="toggle-core-mortgage" class="control-button active" data-target="core-mortgage-news" onclick="toggleSection(this)">Core News & Rates</button>
            <button id="toggle-housingwire-authors" class="control-button active" data-target="housingwire-authors" onclick="toggleSection(this)">HW: Key Authors</button>
            <button id="toggle-company-news" class="control-button active" data-target="company-news-tags" onclick="toggleSection(this)">Company Focus</button>
            <button id="toggle-real-estate-economy" class="control-button active" data-target="real-estate-market" onclick="toggleSection(this)">Real Estate & Economy</button>
            <button id="toggle-regulation" class="control-button active" data-target="regulation-compliance" onclick="toggleSection(this)">Regulation & CFPB</button>
            <button id="toggle-fintech-finance" class="control-button active" data-target="finance-fintech" onclick="toggleSection(this)">FinTech & Finance</button>
            <button id="toggle-community" class="control-button active" data-target="community-pulse-feed" onclick="toggleSection(this)">Community Pulse</button>
        </div>
    </div>
</header>

<details open="open" style="margin: 8px auto; max-width: 1400px; padding: 16px; box-shadow: 0 0 4px #33333333; border-radius: 8px;"><summary>Click to Hide/Show AI Summary</summary>
<div id="ai-insight-panel" class="feed-section">
    <div id="ai-summary-header">
         <h2>‚ú® AI Strategy Summary [Slowed in DEV]</h2>
         <button id="copy-summary-button" onclick="copyAISummary()" title="Copy the full AI Summary to your clipboard" disabled>Copy Summary</button>
    </div>
    
    <div id="ai-summary-status">
        </div>
    
    <div id="ai-summary-content">
        <p>AI summary is slowed in DEV to preserve resources</p>
    </div>
</div>
</details>

<div id="core-mortgage-news" class="feed-section">
    <h2>üìà Core Mortgage News & Rates (MND, HousingWire, NMN)</h2>
    <div class="news-grid-container" data-feed-id="core-mortgage-news">
        <div class="news-grid">Loading Core Mortgage News...</div>
    </div>
</div>

<div id="housingwire-authors" class="feed-section">
    <h2>‚úçÔ∏è HousingWire: Key Author Insights (Kim, Kleimann, Nunes)</h2>
    <div class="news-grid-container" data-feed-id="housingwire-authors">
        <div class="news-grid">Loading Key Author Insights...</div>
    </div>
</div>

<div id="company-news-tags" class="feed-section">
    <h2>üèõÔ∏è Company Focus & Press Releases (Rocket, UWM)</h2>
    <div class="news-grid-container" data-feed-id="company-news-tags">
        <div class="news-grid">Loading Company Focus & Press Releases...</div>
    </div>
</div>

<div id="real-estate-market" class="feed-section">
    <h2>üèòÔ∏è Real Estate Market & Economic Influencers (Calculated Risk, Inman)</h2>
    <div class="news-grid-container" data-feed-id="real-estate-market">
        <div class="news-grid">Loading Real Estate Market & Economy...</div>
    </div>
</div>

<div id="regulation-compliance" class="feed-section">
    <h2>‚öñÔ∏è Regulation & Compliance (CFPB, JD Supra)</h2>
    <div class="news-grid-container" data-feed-id="regulation-compliance">
        <div class="news-grid">Loading Regulation & Compliance...</div>
    </div>
</div>

<div id="finance-fintech" class="feed-section">
    <h2>üíª FinTech & Finance Innovation (TechCrunch, American Banker)</h2>
    <div class="news-grid-container" data-feed-id="finance-fintech">
        <div class="news-grid">Loading FinTech & Finance Innovation...</div>
    </div>
</div>

<div id="community-pulse-feed" class="feed-section">
    <h2>üó£Ô∏è Community Pulse (Reddit: r/Mortgage, r/FTHB, r/REI)</h2>
    <div id="community-pulse-container">
        </div>
</div>
   
    <script>
        /* --- JavaScript for Theme Switching, Fetching, Rendering, and Controls --- */

        // --- BLACKLIST KEYWORDS ---
        const BLACKLIST_KEYWORDS = [
            "coupon code:",
            "promo code:",
            "discount offer:",
            "save now",
            "limited time deal",
            "free trial",
            "get 50%"
        ];

        const EDITORIAL_FEEDS = [
    // --- CORE MORTGAGE INDUSTRY NEWS & RATES ---
    { id: 'core-mortgage-news', url: 'https://www.mortgagenewsdaily.com/rss/all.aspx', source: 'Mortgage News Daily' },
    { id: 'core-mortgage-news', url: 'https://www.housingwire.com/feed/', source: 'HousingWire (General)' },
    { id: 'core-mortgage-news', url: 'https://www.nationalmortgagenews.com/rss/headlines.xml', source: 'National Mortgage News (Headlines)' },
    { id: 'core-mortgage-news', url: 'https://www.nationalmortgagenews.com/feed?rss=true', source: 'NMN (The Latest Feed)' },

    // --- AUTHOR & SPECIFIC HOUSINGWIRE COVERAGE (User Requested) ---
    { id: 'housingwire-authors', url: 'https://www.housingwire.com/author/Connie-Kim/feed/', source: 'HousingWire: Connie Kim' },
    { id: 'housingwire-authors', url: 'https://www.housingwire.com/author/James-Kleimann/feed/', source: 'HousingWire: James Kleimann' },
    { id: 'housingwire-authors', url: 'https://www.housingwire.com/author/Flavia-Furlan-Nunes/feed/', source: 'HousingWire: Fl√°via Nunes' },
    { id: 'company-news-tags', url: 'https://www.housingwire.com/tag/rocket-mortgage/feed/', source: 'HousingWire: Rocket Mortgage Tag' },

    // --- COMPANY PRESS RELEASES (User Requested) ---
    // NOTE: These are grouped under 'company-news-tags' for rendering purposes
    { id: 'company-news-tags', url: 'https://www.rocketcompanies.com/feed/?post_type=press_release', source: 'Rocket Companies PR' },
    { id: 'company-news-tags', url: 'https://feed.businesswire.com/rss/home/company/United+Wholesale+Mortgage%2C+LLC/w6euAGJXjezVpz22AaGCsA==?_gl=1*16nikhv*_gcl_au*MzE3OTYyNzg4LjE3MjQ3NjUwMjM.*_ga*MTI5NTUzNDI3OS4xNzI0NzY1MDIz*_ga_ZQWF70T3FK*MTcyNjA2NzQyNC4zLjEuMTcyNjA2NzQzOS40NS4wLjA.', source: 'UWM Business Wire' },

    // --- REAL ESTATE MARKET & ECONOMIC INFLUENCERS ---
    { id: 'real-estate-market', url: 'https://www.calculatedriskblog.com/feeds/posts/default', source: 'Calculated Risk' },
    { id: 'real-estate-market', url: 'https://www.inman.com/feed/', source: 'Inman News' },
    { id: 'real-estate-market', url: 'https://www.dsnews.com/rss', source: 'DS News (Default Servicing)' },

    // --- REGULATION & COMPLIANCE ---
    { id: 'regulation-compliance', url: 'https://www.jdsupra.com/rss/browse.aspx?ftid=2334', source: 'JD Supra: Mortgage Law' },
    { id: 'regulation-compliance', url: 'https://www.consumerfinance.gov/about-us/newsroom/feed/', source: 'CFPB Newsroom' },

    // --- FINANCE, FINTECH, & INDUSTRY TECHNOLOGY ---
    { id: 'finance-fintech', url: 'https://techcrunch.com/category/fintech/feed/', source: 'TechCrunch: Fintech' },
    // NOTE: The Block RSS feed is broken/dead; removed for reliability
    { id: 'finance-fintech', url: 'https://www.americanbanker.com/feeds/news', source: 'American Banker' },

    // --- OTHER (User Requested) ---
    { id: 'other-feeds', url: 'https://podcastfeeds.nbcnews.com/HL4TzgYC', source: 'Dateline NBC (Podcast)' },
    ];

    const REDDIT_FEEDS = [
        { id: 'r/realestateinvesting', url: 'https://www.reddit.com/r/realestateinvesting.rss', subreddit: 'realestateinvesting' },
        { id: 'r/Mortgage', url: 'https://www.reddit.com/r/Mortgage.rss', subreddit: 'Mortgage' },
        { id: 'r/FirstTimeHomeBuyer', url: 'https://www.reddit.com/r/FirstTimeHomeBuyer.rss', subreddit: 'FirstTimeHomeBuyer' },
        { id: 'r/financialindependence', url: 'https://www.reddit.com/r/financialindependence.rss', subreddit: 'financialindependence' },
        { id: 'r/personalfinance', url: 'https://www.reddit.com/r/personalfinance.rss', subreddit: 'personalfinance' },
    ];
       
        let HIDDEN_LINKS = new Set();
       
        // --- THEME LOGIC (Triple Mode) ---
        const THEMES = ['light-mode', 'dark-mode', 'midnight-mode'];
        const THEME_LABELS = {
            'light-mode': '‚òÄÔ∏è Switch to Dark Mode',
            'dark-mode': 'üåô Switch to Midnight Mode',
            'midnight-mode': 'üåå Switch to Light Mode'
        };

        function toggleTheme() {
            const body = document.body;
            const toggleButton = document.getElementById('theme-toggle');
            
            // Get current theme from body class (or default)
            let currentTheme = THEMES.find(t => body.classList.contains(t)) || 'light-mode';
            
            const currentIndex = THEMES.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % THEMES.length;
            const newTheme = THEMES[nextIndex];

            // Remove all existing theme classes and add the new one
            body.classList.remove(...THEMES);
            body.classList.add(newTheme);
            
            localStorage.setItem('theme', newTheme);
            // Set the button text to prompt the switch to the *next* theme (which is the current theme's label)
            toggleButton.textContent = THEME_LABELS[newTheme];
        }

        function loadThemePreference() {
            const body = document.body;
            const toggleButton = document.getElementById('theme-toggle');
            const savedTheme = localStorage.getItem('theme') || 'light-mode';
            
            // Apply the saved theme and set the correct button label
            body.classList.remove(...THEMES);
            body.classList.add(savedTheme);
            
            // Set the button text to prompt the switch to the *next* theme
            toggleButton.textContent = THEME_LABELS[savedTheme];
        }
       
        // --- UPDATED: CLICK TO COPY LOGIC (Excludes Header/Status) ---
        window.copyAISummary = async function() {
            const summaryDiv = document.getElementById('ai-summary-content'); 
            const copyButton = document.getElementById('copy-summary-button');
            const originalText = 'Copy Summary'; 
            
            const textToCopy = summaryDiv.innerText;

            try {
                await navigator.clipboard.writeText(textToCopy);
                copyButton.textContent = '‚úÖ Copied!';
                copyButton.style.backgroundColor = 'var(--secondary-accent-1)';
                copyButton.style.borderColor = 'var(--secondary-accent-1)';
            } catch (err) {
                console.error('Failed to copy text: ', err);
                copyButton.textContent = '‚ùå Failed!';
                copyButton.style.backgroundColor = 'var(--hide-color)';
                copyButton.style.borderColor = 'var(--hide-color)';
            }

            // Revert button text and color after a short delay
            setTimeout(() => {
                copyButton.textContent = originalText;
                copyButton.style.backgroundColor = 'var(--accent-color)';
                copyButton.style.borderColor = 'var(--accent-color)';
            }, 2000);
        }

        // Helper to enable the copy button once the summary is loaded
        function enableCopyButton() {
             const copyButton = document.getElementById('copy-summary-button');
             copyButton.disabled = false;
             copyButton.textContent = 'Copy Summary';
        }
        // --- END CLICK TO COPY LOGIC ---


        // --- VIEW TOGGLE LOGIC ---
       
        window.setListView = function(view) {
            const body = document.body;
            const gridButton = document.getElementById('grid-view-button');
            const listButton = document.getElementById('list-view-button');

            if (view === 'list') {
                body.classList.add('list-view');
                listButton.classList.add('active');
                gridButton.classList.remove('active');
                localStorage.setItem('newsView', 'list');
            } else {
                body.classList.remove('list-view');
                gridButton.classList.add('active');
                listButton.classList.remove('active');
                localStorage.setItem('newsView', 'grid');
            }
        }

        function loadViewPreference() {
            const savedView = localStorage.getItem('newsView') || 'grid';
            setListView(savedView);
        }

        // --- FILTER BAR TOGGLE LOGIC ---
        window.toggleFilterBar = function() {
            const filterBar = document.getElementById('filter-bar-container');
            const toggleButton = document.getElementById('toggle-filter-bar-btn');
           
            const isHidden = filterBar.classList.toggle('hidden');
           
            if (isHidden) {
                toggleButton.textContent = 'Show Filter Bar';
                localStorage.setItem('filterBarHidden', 'true');
            } else {
                toggleButton.textContent = 'Hide Filter Bar';
                localStorage.setItem('filterBarHidden', 'false');
            }
        }
       
        function loadFilterBarPreference() {
            const filterBar = document.getElementById('filter-bar-container');
            const toggleButton = document.getElementById('toggle-filter-bar-btn');
            const isHidden = localStorage.getItem('filterBarHidden') === 'true';
           
            if (isHidden) {
                filterBar.classList.add('hidden');
                toggleButton.textContent = 'Show Filter Bar';
            } else {
                filterBar.classList.remove('hidden');
                toggleButton.textContent = 'Hide Filter Bar';
            }
        }

        // --- PERSISTENCE & UTILITY LOGIC ---
       
        function loadHiddenLinks() {
            const storedLinks = localStorage.getItem('hiddenNewsLinks');
            if (storedLinks) {
                HIDDEN_LINKS = new Set(JSON.parse(storedLinks));
            }
        }
       
        function saveHiddenLinks() {
            localStorage.setItem('hiddenNewsLinks', JSON.stringify(Array.from(HIDDEN_LINKS)));
        }

        window.hideTileForever = function(button, link) {
            const card = button.closest('.news-card');
            if (card && link) {
                card.classList.add('hidden-tile');
                HIDDEN_LINKS.add(link);
                saveHiddenLinks();
            }
        }
       
        window.resetHiddenTiles = function() {
            if (confirm("Are you sure you want to reset all permanently hidden news tiles? This cannot be undone.")) {
                localStorage.removeItem('hiddenNewsLinks');
                HIDDEN_LINKS = new Set();
                location.reload(); 
            }
        }
       
        window.filterCards = function() {
            const input = document.getElementById('search-input');
            const filter = input.value.toLowerCase();
            const cards = document.querySelectorAll('.news-card:not(.hidden-tile):not(.auto-filtered)');

            cards.forEach(card => {
                // Ensure data attributes are used for searching
                const title = card.getAttribute('data-search-title') || '';
                const description = card.getAttribute('data-search-desc') || '';
               
                if (title.includes(filter) || description.includes(filter)) {
                    card.style.display = ''; 
                } else {
                    card.style.display = 'none'; 
                }
            });
        }
       
        window.toggleSection = function(button) {
            const targetId = button.getAttribute('data-target');
            const section = document.getElementById(targetId);

            if (!section) return;

            // Note: The max-height trick works best with a fixed large value
            if (section.classList.contains('hidden')) {
                // Remove the class first to trigger the transition based on style change
                section.style.maxHeight = '5000px'; 
                section.classList.remove('hidden');
                button.classList.add('active');
            } else {
                // Set max-height to 0 before adding the hidden class (which prevents instant jump)
                section.style.maxHeight = '0';
                // Wait for transition to finish before setting display/class
                setTimeout(() => {
                    section.classList.add('hidden');
                }, 500); // 500ms delay matches typical CSS transition time
                button.classList.remove('active');
            }
        }

        // --- CORE FETCH AND RENDER LOGIC (FIXED FOR 400 ERROR) ---
        
        /**
         * Renders an individual news card HTML.
         */
        function createCardHtml(item) {
            // Filter out blacklisted items
            const keywordsMatched = BLACKLIST_KEYWORDS.some(keyword => 
                item.title.toLowerCase().includes(keyword) || 
                (item.description && item.description.toLowerCase().includes(keyword))
            );
            if (keywordsMatched) return '';

            // Unique ID based on the link for persistence
            const uid = btoa(item.link).replace(/=/g, '').substring(0, 30);
            const isHidden = HIDDEN_LINKS.has(item.link);
            const pubDate = new Date(item.pubDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            // Prepare content for search attributes
            const searchTitle = item.title.toLowerCase().replace(/[^a-z0-9\s]/g, '');
            const searchDesc = (item.description || '').toLowerCase().replace(/[^a-z0-9\s]/g, '');

            return `
                <div class="news-card ${isHidden ? 'hidden-tile' : ''}" 
                    data-search-title="${searchTitle}" 
                    data-search-desc="${searchDesc}" 
                    data-source="${item.source}" 
                    data-date="${item.pubDate}">
                    
                    <div class="card-controls grid-controls">
                        <span>${item.source}</span>
                        <button onclick="hideTileForever(this, '${item.link}')">Hide Forever</button>
                    </div>

                    <h4><a href="${item.link}" target="_blank" rel="noopener noreferrer">${item.title}</a></h4>
                    <p class="description">${item.description}</p>

                    <div class="date-and-controls">
                        <span class="date">${pubDate}</span>
                        <div class="card-controls list-controls">
                            <span>${item.source}</span>
                            <button onclick="hideTileForever(this, '${item.link}')">Hide Forever</button>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Fetches RSS feeds from the server and renders the news cards.
         * FIX: Sends the individual feed URL in the JSON body as expected by the server.
         */
        async function fetchAndRenderFeeds() {
            // 1. Initialize data structure to hold results per section
            const sectionData = {};
            const containers = {};
            
            // Clear and set loading status for all sections
            document.querySelectorAll('.news-grid-container').forEach(container => {
                const sectionId = container.getAttribute('data-feed-id');
                containers[sectionId] = container.querySelector('.news-grid');
                containers[sectionId].innerHTML = 'Loading Editorial News...';
            });
            document.getElementById('community-pulse-container').innerHTML = ''; 

            // 2. Fetch all editorial feeds concurrently
            const fetchPromises = EDITORIAL_FEEDS.map(feedConfig => {
                return fetch('/api/fetch-rss', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feedUrl: feedConfig.url }) // <-- CRITICAL FIX HERE
                })
                .then(response => {
                    if (!response.ok) {
                        // Throw error to be caught below, including the status
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Combine returned items with their source/ID metadata
                    const items = data.items || [];
                    const articles = items.map(item => ({ 
                        ...item, 
                        source: feedConfig.source,
                        feedUrl: feedConfig.url 
                    }));
                    
                    const sectionId = feedConfig.id;
                    if (!sectionData[sectionId]) {
                        sectionData[sectionId] = [];
                    }
                    sectionData[sectionId].push(...articles);
                })
                .catch(error => {
                    // This error is handled per feed, console logged, but doesn't halt others
                    console.error(`Error fetching feed ${feedConfig.url}:`, error);
                    // Update the specific container with an error message
                    if (containers[feedConfig.id]) {
                         containers[feedConfig.id].innerHTML = `<p class="error-message">Failed to load news: ${error.message}</p>`;
                    }
                });
            });

            // 3. Wait for all fetches to complete
            await Promise.all(fetchPromises.map(p => p.catch(e => e))); 
            
            // 4. Render results to the DOM
            for (const sectionId in sectionData) {
                const container = containers[sectionId];
                if (container) {
                    // Remove duplicates (e.g., if one article appears in multiple feeds)
                    const uniqueArticles = Object.values(sectionData[sectionId].reduce((acc, item) => {
                        acc[item.link] = item;
                        return acc;
                    }, {}));

                    // Sort by date (newest first)
                    uniqueArticles.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
                    
                    container.innerHTML = uniqueArticles.map(createCardHtml).join('');
                }
            }
            
            // 5. Trigger AI summary and Reddit fetch
            generateAISummary(); 
            fetchRedditFeeds(); 
        }

        /**
         * Renders Reddit posts into the community pulse container.
         */
        function renderRedditPosts(posts) {
            const container = document.getElementById('community-pulse-container');
            if (!container) return; 

            container.innerHTML = ''; 

            const postsBySubreddit = posts.reduce((acc, post) => {
                const subreddit = post.subreddit || 'Unknown';
                if (!acc[subreddit]) {
                    acc[subreddit] = [];
                }
                acc[subreddit].push(post);
                return acc;
            }, {});

            for (const subreddit in postsBySubreddit) {
                const subredditTitle = document.createElement('div');
                subredditTitle.className = 'reddit-subsection'; 
                
                const titleHeading = document.createElement('h3');
                titleHeading.textContent = `r/${subreddit} (${postsBySubreddit[subreddit].length} Recent Posts)`;
                subredditTitle.appendChild(titleHeading);

                const grid = document.createElement('div');
                grid.className = 'news-grid'; 
                grid.innerHTML = postsBySubreddit[subreddit].map(item => {
                    const isHidden = HIDDEN_LINKS.has(item.link);
                    // Use new Date(item.pubDate) or item.isoDate if available from parser
                    const pubDate = new Date(item.pubDate || item.isoDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    
                    const searchTitle = (item.title || '').toLowerCase().replace(/[^a-z0-9\s]/g, '');
                    const searchDesc = (item.description || '').toLowerCase().replace(/[^a-z0-9\s]/g, '');

                    // NOTE: This assumes marked.js and DOMPurify are available.
                    let descriptionHtml = item.content ? DOMPurify.sanitize(marked.parse(item.content)) : (item.description || 'No description available.');

                    return `
                        <div class="news-card ${isHidden ? 'hidden-tile' : ''}" 
                            data-search-title="${searchTitle}" 
                            data-search-desc="${searchDesc}"
                            data-source="Reddit: ${item.subreddit}" 
                            data-date="${item.pubDate}">
                            
                            <div class="card-controls grid-controls">
                                <span>r/${item.subreddit}</span>
                                <button onclick="hideTileForever(this, '${item.link}')">Hide Forever</button>
                            </div>
                            
                            <h4><a href="${item.link}" target="_blank" rel="noopener noreferrer">${item.title}</a></h4>
                            <p class="description">${descriptionHtml}</p>

                            <div class="date-and-controls">
                                <span class="date">${pubDate}</span>
                                <div class="card-controls list-controls">
                                    <span>r/${item.subreddit}</span>
                                    <button onclick="hideTileForever(this, '${item.link}')">Hide Forever</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                subredditTitle.appendChild(grid);
                container.appendChild(subredditTitle);
            }
        }


        /**
         * Fetches Reddit feeds from the server.
         * FIX: Sends the subreddit name in the JSON body as expected by the server.
         */
        async function fetchRedditFeeds() {
            const container = document.getElementById('community-pulse-container');
            container.innerHTML = 'Loading Community Pulse...';

            const fetchPromises = REDDIT_FEEDS.map(feedConfig => {
                return fetch('/api/fetch-reddit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subreddit: feedConfig.subreddit }) // <-- CRITICAL FIX HERE
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Map items to include the subreddit name
                    return (data.items || []).map(item => ({ 
                        ...item, 
                        subreddit: feedConfig.subreddit 
                    }));
                })
                .catch(error => {
                    console.error(`Error fetching Reddit feed for ${feedConfig.subreddit}:`, error);
                    return []; // Return empty array to keep Promise.all working
                });
            });

            try {
                const results = await Promise.all(fetchPromises);
                const allPosts = results.flat(); // Flatten the array of arrays
                
                // Sort all posts together (newest first)
                allPosts.sort((a, b) => new Date(b.pubDate || b.isoDate) - new Date(a.pubDate || a.isoDate));

                renderRedditPosts(allPosts);
            } catch (error) {
                console.error('Error in final Reddit compilation:', error);
                 if (container) {
                    container.innerHTML = `<p class="error-message">Failed to load Community Pulse: ${error.message}</p>`;
                }
            }
        }


        // --- AI SUMMARY INTEGRATION FUNCTION (Calls Server) ---
        async function generateAISummary() {
            const summaryHeader = document.getElementById('ai-summary-status');
            const summaryContent = document.getElementById('ai-summary-content');
            
            const summaryPromptType = 'mortgage'; 

            // Disable the copy button during generation
            document.getElementById('copy-summary-button').disabled = true;
            summaryHeader.innerHTML = '‚ú® **Generating new summary...** This may take 30-60 seconds...';
            summaryContent.innerHTML = '<p>Preparing content for analysis...</p>';

            // 2. Get all news content
            const allNewsContainers = document.querySelectorAll('.news-grid-container .news-grid');
            let htmlContent = '';
            allNewsContainers.forEach(container => {
                // IMPORTANT: This grabs the rendered cards which contain the searchable data attributes
                htmlContent += container.innerHTML;
            });

            if (!htmlContent.trim() || htmlContent.includes('Failed to load news')) {
                summaryHeader.innerHTML = '‚ö†Ô∏è **Cannot Generate Summary**';
                summaryContent.innerHTML = '<p>No sufficient content loaded to summarize (or feeds failed to load).</p>';
                document.getElementById('copy-summary-button').disabled = true;
                return;
            }

            // 3. Make the API Call
            try {
                const response = await fetch('/api/summarize-news', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        htmlContent: htmlContent,
                        promptType: summaryPromptType // Send type for server to select prompt
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `Status: ${response.status}` }));
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // 4. Update the UI
                summaryHeader.innerHTML = data.header || '‚ú® AI Strategy Summary (Generated)';
                
                // Render Markdown content (ensure marked.js and DOMPurify are loaded)
                const renderedHtml = DOMPurify.sanitize(marked.parse(data.summary));
                summaryContent.innerHTML = renderedHtml;
                
                enableCopyButton();

            } catch (error) {
                console.error("AI Proxy Error:", error.message);
                summaryHeader.innerHTML = '‚ùå **AI Summary Failed**';
                summaryContent.innerHTML = `<p class="error-message">AI Proxy Error: ${error.message}</p>`;
                document.getElementById('copy-summary-button').disabled = true;
            }
        }
        // --- END AI SUMMARY INTEGRATION FUNCTION ---
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadThemePreference();
            loadViewPreference();
            loadFilterBarPreference();
            loadHiddenLinks(); 
            
            // NOTE: You must ensure marked.js and DOMPurify are loaded via <script> tags in the <head>
            // or the rendering functions (including AI summary) will fail.
            fetchAndRenderFeeds(); 
        });

    </script>
</body>
</html>
